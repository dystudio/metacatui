<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>MetacatUI Dev Docs: Source: src/js/models/bookkeeper/Customer.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles/style.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/js/models/bookkeeper/Customer.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* global define */
define(["jquery",
        "underscore",
        "backbone"],
  function($, _, Backbone, Quotas) {
    /**
     * @classdesc A Customer Model represents a single instance of a Customer object from the
     * DataONE Bookkeeper data model.
     * Customer represent a person or group
     *
     * @class Customer
     * @name Customer
     * @constructor
    */
    var Customer = Backbone.Model.extend(
      /** @lends Customer.prototype */ {

      /**
      * The name of this type of model
      * @type {string}
      */
      type: "Customer",

      /**
      * Default attributes for Customer models
      * @name Customer#defaults
      * @type {Object}
      * @property {string} id  The unique identifier of this Customer, from Bookkeeper
      * @property {string} object The name of this type of Bookkeeper object, which will always be "customer"
      * @property {string} subject The DataONE subject/username of this Customer
      * @property {number} balance The monetary balance for this Customer's account
      * @property {object} address The mailing address
      * @property {number} created The date timestamp when this Customer was created
      * @property {boolean} delinquent If true, this Customer's account is deliquent in payments
      * @property {string} email The email address
      * @property {object} invoiceSettings
      * @property {object} metadata Additional metadata about this Customer
      * @property {string} givenName The first name of this person
      * @property {string} surName The last name of this person
      * @property {string} name The full name of this person
      * @property {User} userModel A reference to a User model that represents the same person as this Customer,
      * @property {string} erroMessage A user-facing error message that explains why the most recent save() or fetch() failed
      */
      defaults: function(){
        return {
          id: null,
          object: "customer",
          subject: "",
          balance: 0,
          address: {},
          created: null,
          delinquent: false,
          discount: {},
          email: "",
          invoiceSettings: {},
          metadata: {},
          givenName: "",
          surName: "",
          name: "",
          userModel: null
        }
      },

      /**
      * Constructs and returns the URL string that is used to fetch and save a Customer
      */
      url: function(){

        if( typeof this.get("id") == "string" &amp;&amp; this.get("id").length > 0 ){
          return MetacatUI.appModel.get("bookkeeperCustomersUrl") + "/" + this.get("id");
        }
        else if(this.get("subject")){
          return MetacatUI.appModel.get("bookkeeperCustomersUrl") + "?subject=" + encodeURIComponent(this.get("subject"));
        }
        else{
          return MetacatUI.appModel.get("bookkeeperCustomersUrl");
        }

      },

      /**
      * Parses and returns the raw json returned from fetch()
      * @param {JSON} customersJSON - The raw JSON returned from Customer.fetch()
      * @returns {JSON} The model data in JSON form
      */
      parse: function(customersJSON){

        var parsedJSON = {};

        if( customersJSON &amp;&amp; Array.isArray(customersJSON.customers) ){
          if( customersJSON.customers.length == 1 ){
            parsedJSON = customersJSON.customers[0];
          }
          else{
            return parsedJSON;
          }
        }

        //Store a reference to this Customer in the UserModel
        if( MetacatUI.appUserModel.get("username") == parsedJSON.subject ){
          parsedJSON.userModel = MetacatUI.appUserModel;
          MetacatUI.appUserModel.set("dataoneCustomer", this);
        }

        return parsedJSON;
      },

      /**
      * Fetches the Customer from the DataONE Bookkeeper service
      */
      fetch: function(){

        try{
          var fetchOptions = {
            error: function(customer, xhr){
              if( xhr.status == 404 ){
                customer.trigger("notFound");
              }
            }
          }

          fetchOptions = Object.assign(fetchOptions, MetacatUI.appUserModel.createAjaxSettings());

          //Call Backbone.Model.fetch to retrieve the info
          return Backbone.Model.prototype.fetch.call(this, fetchOptions);
        }
        catch(e){
          console.error("Error while fetching the Customer: ", e);
          Backbone.Model.prototype.fetch.call(this);
        }
      },

      /**
      * Saves this Customer to the DataONE Bookkeeper service
      */
      save: function(){

        try{

          //If the Customer is new, POST a new Customer object
          if( this.isNew() ){

            //The data for this Customer in JSON form
            var customerData = {
                "object": "customer",
                "givenName": this.get("givenName"),
                "surName": this.get("surName"),
                "email": this.get("email"),
                "subject": this.get("subject")
            }

            var saveOptions = {
              dataType: "json",
              error: function(customer, response){
                if( response.status = 500 &amp;&amp; response.responseText.indexOf("A customer exists with the given email") > -1 ){
                  customer.set("errorMessage", "There is already a " + MetacatUI.appModel.get("dataonePlusName") +
                               " account with that email. Either sign up with a " +
                               "different email or login to your other account to access your existing " + MetacatUI.appModel.get("dataonePlusGeneralName") + ".");
                  customer.trigger("error");
                }
                else{
                  MetacatUI.appModel.logError("Failed to save the Customer model: " + response.responseText, true);
                  customer.trigger("error");
                }
              }
            }

            saveOptions = _.extend(saveOptions, MetacatUI.appUserModel.createAjaxSettings());

            return Backbone.Model.prototype.save.call(this, customerData, saveOptions);
          }

        }
        catch(e){
          console.error("Could not save the Customer: ", e);
          MetacatUI.appModel.logError("JS runtime error while trying to save the Customer model: " + e.message, true);
          this.trigger("error");
        }

      },

      /**
      * Gets common attributes from the given User model and sets it on this model
      * @param {User} user - The User model to copy attributes from
      */
      copyFromUser: function(user){

        try{
          if( typeof user == "undefined" ){
            return;
          }

          this.set({
            subject: user.get("username"),
            givenName: user.get("firstName"),
            surName: user.get("lastName"),
            email: user.get("email")
          });
        }
        catch(e){
          console.error("Could not copy from user: ", e);
        }
      }

  });

  return Customer;
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="AppConfig.html">AppConfig</a></li><li><a href="MetacatUI.html">MetacatUI</a></li></ul><h3>Classes</h3><ul><li><a href="AccessPolicy.html">AccessPolicy</a></li><li><a href="AccessPolicyView.html">AccessPolicyView</a></li><li><a href="AccessRule.html">AccessRule</a></li><li><a href="AppModel.html">AppModel</a></li><li><a href="AppView.html">AppView</a></li><li><a href="BooleanFilter.html">BooleanFilter</a></li><li><a href="ChoiceFilter.html">ChoiceFilter</a></li><li><a href="Citations.html">Citations</a></li><li><a href="CollectionModel.html">CollectionModel</a></li><li><a href="ColorPaletteView.html">ColorPaletteView</a></li><li><a href="CreateOrderView.html">CreateOrderView</a></li><li><a href="Customer.html">Customer</a></li><li><a href="DataCatalogView_drawTiles-TextOverlay.html">TextOverlay</a></li><li><a href="DataCatalogViewWithFilters.html">DataCatalogViewWithFilters</a></li><li><a href="DataItemView.html">DataItemView</a></li><li><a href="DataONEObject.html">DataONEObject</a></li><li><a href="DataPackage.html">DataPackage</a></li><li><a href="DateFilter.html">DateFilter</a></li><li><a href="DraftsView.html">DraftsView</a></li><li><a href="EditCollectionView.html">EditCollectionView</a></li><li><a href="EditorView.html">EditorView</a></li><li><a href="EML211.html">EML211</a></li><li><a href="EML211EditorView.html">EML211EditorView</a></li><li><a href="EMLEntity.html">EMLEntity</a></li><li><a href="EMLEntityView.html">EMLEntityView</a></li><li><a href="EMLGeoCoverage.html">EMLGeoCoverage</a></li><li><a href="EMlGeoCoverageView.html">EMlGeoCoverageView</a></li><li><a href="EMLNonNumericDomain.html">EMLNonNumericDomain</a></li><li><a href="EMLNumericDomain.html">EMLNumericDomain</a></li><li><a href="EMLPartyView.html">EMLPartyView</a></li><li><a href="EMLTemporalCoverage.html">EMLTemporalCoverage</a></li><li><a href="EMLView.html">EMLView</a></li><li><a href="Filter.html">Filter</a></li><li><a href="FilterGroup.html">FilterGroup</a></li><li><a href="FilterGroupsView.html">FilterGroupsView</a></li><li><a href="Filters.html">Filters</a></li><li><a href="GroupListView.html">GroupListView</a></li><li><a href="ImageUploaderView.html">ImageUploaderView</a></li><li><a href="LookupModel.html">LookupModel</a></li><li><a href="MarkdownEditorView.html">MarkdownEditorView</a></li><li><a href="MarkdownView.html">MarkdownView</a></li><li><a href="MetadataView.html">MetadataView</a></li><li><a href="MetricModalView.html">MetricModalView</a></li><li><a href="NavbarView.html">NavbarView</a></li><li><a href="NumericFilter.html">NumericFilter</a></li><li><a href="ObjectFormats.html">ObjectFormats</a></li><li><a href="Order.html">Order</a></li><li><a href="Orders.html">Orders</a></li><li><a href="OrdersView.html">OrdersView</a></li><li><a href="OrderView.html">OrderView</a></li><li><a href="PortalDataView.html">PortalDataView</a></li><li><a href="PortalEditorView.html">PortalEditorView</a></li><li><a href="PortalListView.html">PortalListView</a></li><li><a href="PortalLogosView.html">PortalLogosView</a></li><li><a href="PortalMembersView.html">PortalMembersView</a></li><li><a href="PortalModel.html">PortalModel</a></li><li><a href="PortalSectionView.html">PortalSectionView</a></li><li><a href="PortalUsagesView.html">PortalUsagesView</a></li><li><a href="PortalView.html">PortalView</a></li><li><a href="PortEditorDataView.html">PortEditorDataView</a></li><li><a href="PortEditorImageView.html">PortEditorImageView</a></li><li><a href="PortEditorLogosView.html">PortEditorLogosView</a></li><li><a href="PortEditorMdSectionView.html">PortEditorMdSectionView</a></li><li><a href="PortEditorSectionsView.html">PortEditorSectionsView</a></li><li><a href="PortEditorSectionView.html">PortEditorSectionView</a></li><li><a href="PortEditorSettingsView.html">PortEditorSettingsView</a></li><li><a href="Product.html">Product</a></li><li><a href="Products.html">Products</a></li><li><a href="QualityReport.html">QualityReport</a></li><li><a href="Quota.html">Quota</a></li><li><a href="Quotas.html">Quotas</a></li><li><a href="RegisterCitationView.html">RegisterCitationView</a></li><li><a href="Search.html">Search</a></li><li><a href="SolrResultList.html">SolrResultList</a></li><li><a href="SpatialFilter.html">SpatialFilter</a></li><li><a href="Stats.html">Stats</a></li><li><a href="TableEditorView.html">TableEditorView</a></li><li><a href="ToggleFilter.html">ToggleFilter</a></li><li><a href="UIRouter.html">UIRouter</a></li><li><a href="Usage.html">Usage</a></li><li><a href="Usages.html">Usages</a></li><li><a href="User.html">User</a></li><li><a href="UserSettingsView.html">UserSettingsView</a></li><li><a href="UserView.html">UserView</a></li></ul><h3>Global</h3><ul><li><a href="global.html#appConfigPath">appConfigPath</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Tue Oct 20 2020 22:49:21 GMT-0500 (Central Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
